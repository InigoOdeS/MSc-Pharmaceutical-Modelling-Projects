---
title: "Project 2"
author: "Iñigo Ortiz de Salazar"
date: "23/11/2018"
output:
  html_document:
    code_folding: show
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
  word_document:
    toc: yes
    toc_depth: '2'
subtitle: BPI889 placebo data
---

# Setup Environment

I am working as a modelling scientist at Big Pharma Inc in the Drug Metabolism and Pharmacokinetics group. BPI889 protease inhbitor is under development as a treatment againts HIV/AIDS, which is a follow-up compount to Indinavir. My purpose is to perform data management, graphical exploration and initial statistical analysis of the data obtained from the phase IIb study, and submit my results in a report generated by R markdowm. This scrip will guide me to generate the report. 

## Load R Packages

**Questions:**

1. What language was used?
R
2. What is the name of the chunk?
r load packages
3. What does the `message = FALSE` option do?
It tells not to output messages in the report. 

```{r load packages, message = FALSE}
library(tidyr)    # used for putting data into long format
library(knitr)    # used for creation of the report

```


## Load the Data Sets
### Set the Working Directory


**Question:**

1. What are the names of the sub-directories present under `/Data`?


### Define the Pathways


#### Define the Pathway for the `PD` Data Set


```{r define pd path}
dir_project2_pd   <- "C:/Users/iñigo erabiltzailea/Desktop/R_Studio/Project_2"
file_project2_pd  <- "BPI889_PD_run-in.csv"
PD  <- paste(dir_project2_pd, file_project2_pd, sep = '/')
```


**Question:** 

1. With relative paths what do `.` and `..` mean?
'.' means current directory and '..'parent directory. 


#### Define the Pathway for the `COV` Data Set


```{r define cov path}
dir_Project2_cov   <- "C:/Users/iñigo erabiltzailea/Desktop/R_Studio/Project_2"
file_Project2_cov  <- "BPI889_demographics.tab"
COV  <- paste(dir_Project2_cov, file_Project2_cov, sep = "/")
```


### Import the Data Sets
#### Import `PD` Data Set


```{r read-in pd}
data_PD <- read.csv(PD, header = TRUE, as.is = TRUE)
```


#### Import `COV` Data Set


```{r read-in cov}
data_COV <- read.table(COV, header = TRUE, as.is = TRUE)
```

**Questions:** 

1. What does the option `header = TRUE` do?
Indicates that the file contains the names of the variables as its first line.
2. Why was the option `as.is = TRUE` used?
To not convert the characters to factors, to leave them as they as they are. 

# Input Check
## Check Imported Data Sets


### Structure of the `PD` data set


```{r pd structure}
str(data_PD)
```


**Questions:** using the output of the `str()` function

1. How many rows and columns does the `PD` data set has?
4 columns and 300 rows. 
2. What does `chr` and `int` refer to in the output?
It refers to the class of each column, chr means character and int means interger.
3. Can you explain why the column names of the `PD` data set are different from the name seen in the `.csv` file with the Rstudio viewer (i.e. first column named `X` and spaces have been replaced by dots in the other columns)?
Because it was set to make dfferent columns between dots. Due to before the first dot there wasn't a name, the column name was set by default to X.

### Structure of `COV` Data Set


```{r cov structure}
str(data_COV)
```


**Question:** using the output of the `str()` function:

1. How many rows and columns does the `COV` data set has?
7 columns an 300 rows

## Glance at the Data Sets

### Head of the `PD` Data Set


```{r knitr kable example, eval = FALSE}
# This is an example do not write code here
kable(x = mtcars,
      align = 'c',
      row.names = FALSE,
      caption = 'Head of the mtcars data set')
```

```{r pd head table}
head_pd <- head(data_PD, n = 5)
kable(x = head_pd,
      align = 'c',
      row.names = FALSE,
      caption = 'Head of the PD data set')

```


**Question:**

1. What does the chunk option `eval = FALSE` used in the example do?
knit will not run the code in the code chunk

### Head of the `COV` Data Set


```{r cov head table}
head_cov <- head(data_COV, n = 5)
kable(x = head_cov,
      align = 'c',
      row.names = FALSE,
      caption = 'Head of the COV data set')

```


# Data Management 
## The `PD` Data Set
### Set `ID` Column Name

```{r pd id column}
colnames(data_PD)[1:4] <- c('ID', 'day.000', 'day.007', 'day.014')
```


### Transform the Data Set to Long Format


```{r tidy pd data}
tidydata_pd <- gather(data  = data_PD,
                   key   = "TIME",
                   value = "CD4", -"ID")
```


```{r pd head long}
nrow(tidydata_pd)
ncol(tidydata_pd)
head_tidydata_pd <- head(tidydata_pd, n = 5)
kable(x = head_tidydata_pd,
      align = 'c',
      row.names = FALSE,
      caption = 'Head of the tidy data PD set')
```


### Create Numeric `CD4` Column


```{r convert cd4 numeric}
tidydata_pd$CD4 <- as.numeric(tidydata_pd$CD4)
```


**Question:** 

1. Why do you get the warning message: `NAs introduced by coercion` when converting the `CD4` column into `numeric`?
When CD4 is converted from character to numeric everything that is not a number like "." are converted to NA.

### Create Numeric `TIME` Column


```{r convert time numeric}
tidydata_pd$TIME <- gsub(pattern = '[^0-9]', replacement = '', x = tidydata_pd$TIME)
tidydata_pd$TIME <- as.numeric(tidydata_pd$TIME)
```


**Question:**

1. What does `'[^0-9]'` pattern mean?
Everything but numbers.

## The `COV` Data Set
### Format Categorical Data

#### Factorize the `SEX` Column


```{r factor example, eval = FALSE}
# This is an example do not write code here
factor(x      = mtcars$cyl,
       levels = c(4, 6, 8),
       labels = c('Small', 'Medium', 'Big')
```


```{r convert sex to factor}
data_COV$SEX <- factor(x = data_COV$SEX,
                        levels = c("M", "F"),
                        labels = c("Male", "Female")
                        )
```


#### Factorize the `TB` Column


```{r convert tb to factor}
data_COV$TB <- factor(x = data_COV$TB,
                        levels = c(0, 1),
                        labels = c("HIV", "HIV+TB")
                        )
```


### Create the `BMI` Column


$$BMI \; (mg/m^2) = \frac{Weight \; (kg)}{Height^2 \; (m^2)}$$


```{r bmi calculation}
data_COV$BMI <- data_COV$WT/((data_COV$HT/100)^2)
data_COV$BMI <- round(data_COV$BMI, 2)
```


### Create the `CBMI` Column


```{r cbmi calculation}
data_COV$CBMI <- ifelse(data_COV$BMI < 18.5, 1,
                        ifelse(data_COV$BMI < 25, 2,
                               ifelse(data_COV$BMI < 30, 3, 4)))
                        
  
data_COV$CBMI <- factor(x = data_COV$CBMI,
                        levels = c(1, 2, 3, 4),
                        labels = c("Underweight", "Normal", "Overweight", "Obese")
                        )
table(data_COV$CBMI)
```

**Questions:** using the results from the `table()` function, are there any:

1. Obese subjects?
Yes, 60
2. Underweight subjects?
No


### Create the `FFM` Column


$$FFM \; (kg) = WHS_{max} (kg/m^2) \cdot Height^2 (m^2) \cdot \frac{Weight (kg)}{WHS_{50} (kg/m^2) \cdot Height^2 (m^2)+ Weight (kg)}$$

where:

- $WHS_{max}$ is 42.92 kg/m^2^ for males and for 37.99 kg/m^2^ females.
- $WHS_{50}$ is 30.93 kg/m^2^ for males and 35.98 kg/m^2^ for females.


```{r create fat free mass}
data_COV$FFM <- ifelse(
  data_COV$SEX == "Male",
        (42.92 * ((data_COV$HT/100) ^ 2)) * (data_COV$WT/(30.93 * ((data_COV$HT/100)^2) + data_COV$WT)),
        (37.99 * ((data_COV$HT/100) ^ 2)) * (data_COV$WT/(35.98 * ((data_COV$HT/100)^2) + data_COV$WT)))
                       
data_COV$FFM <- round(data_COV$FFM, 1)
```


### Create the `AECD4` Column


```{r create cd4 adverse events}
data_COV$AECD4 <- ifelse(data_COV$BCD4 < 50, 4,
                        ifelse(data_COV$BCD4 < 200 , 3,
                               ifelse(data_COV$BCD4 < 500, 2, 1)))
data_COV$AECD4 <- factor(x = data_COV$AECD4,
                        levels = c(1, 2, 3, 4),
                        labels = c("mild", "moderate", "severe", "life-threatening")
                        )
```


## Save the Data to an R Archive


```{r save cov data set as RData}
save(data_COV, file = 'BPI889_covariates_formated.RData')
```


## Merge `PD` and `COV` Data Sets
### Perform the Merge


```{r merge pd and cov}
data_all <- merge(tidydata_pd, data_COV, by = "ID")
```


**Question:** 

1. Why did we use the `merge()` function and not a simple column bind (`cbind()`) to combine the `PD` and `COV` data set?
When usin cbind it doesn't combine the data by id, it just adds the two columns. 

### Evaluate the Merge


```{r str and head of data_all}
str(data_all)
head_data_all <- head(data_all, n = 5)
kable(x = head_data_all,
      align = 'c',
      row.names = FALSE,
      caption = 'Head of all data set')
```


**Questions:** 

1. Compare the number of rows of `data_all` to `data_cov` and `data_pd`. Can you explain these differences?
It takes the ID columns rows to create the data_all and the PD data has 900 rows. 
2. Same question with the number of columns.
The columns are added by ID, so 10 and 3 became 12. 

### Arrange the Data
#### Reorder Columns


```{r reorder columns}
cols <- c("ID", "TIME", "CD4", "BCD4", "AECD4", "BVL", "WT", "HT", "FFM", "BMI", "CBMI", "SEX", "TB")
setdiff(cols, colnames(data_all))
data_all <- data_all[cols]
```


#### Reorder Rows


```{r reorder rows}
data_all <- data_all[order(data_all$ID, data_all$TIME), ]
```


# Data Summary

## Summary of Time Varing Columns

```{r time varying summary}
summary(data_all$TIME)
summary(data_all$CD4)
```


**Questions:** 

1. What is the range of `TIME`?
0-14
2. What is the range of `CD4` count? 
101.6-376.6
3. Do you think that missingness is a problem with these data?
There are 27 values missing and there re almost 900 value in total, so it can be argue that is not a major problem. 

**Bonus question:**

1. Can you think of an alternative we could have used to generate a summary for each of the studied time points (i.e. 0, 7 and 14 days)?

```{r summary per days}
subseteddata0 <- subset(data_all, TIME == 0)
subseteddata7 <- subset(data_all, TIME == 7)
subseteddata14 <- subset(data_all, TIME == 14)
summary(subseteddata0)
summary(subseteddata7)
summary(subseteddata14)
```



## Summary of Time Constant Columns


```{r create data_unique}
data_unique <- data_all[!duplicated(data_all$ID), -2]
```


### Continuous Variables


```{r summary non-time varying continuous}
summary(data_unique$BCD4)
summary(data_unique$BVL)
summary(data_unique$WT)
summary(data_unique$HT)
summary(data_unique$FFM)
summary(data_unique$BMI)
```


### Discrete Variables


```{r summary non-time varying discrete}
summary(data_unique$AECD4)
summary(data_unique$CBMI)
summary(data_unique$SEX)
summary(data_unique$TB)
```


# Graphical Analysis

## CD4 Time Profiles


```{r loop example, eval = FALSE}
# This is an example do not write code here
  plot(x = data_all$TIME, y = data_all$CD4, type = 'n')
  for(n in unique(data_all$Subject)) {
  lines(x = data_all$TIME[data_all$Subject == n],
        y = data_all$CD4[data_all$Subject == n],
        col = ifelse(data_all$Wt[Theoph$Subject == n] > 70, 'blue', 'red'))
  }
  legend('topright', legend = c('HIV', 'HIV+1'), 
         col = c('blue', 'red'), lty = 1, bty = 'n')
```
  


```{r cd4 time profiles}
 plot(x = data_all$TIME, y = data_all$CD4, type = 'n')
 for (n in unique(data_all$ID)) {
  lines(x = data_all$TIME[data_all$ID == n],
        y = data_all$CD4[data_all$ID == n],
        col = ifelse(data_all$TB[data_all$ID == n] == 'HIV', 'blue', 'red'))
  }
legend('topright', legend = c('HIV', 'HIV+1'), 
         col = c('blue', 'red'), lty = 1, bty = 'n')
abline(h = 500)
```


## Continuous Covariates
### Distribution

**Instructions:** 


```{r histograms, fig.height = 5, fig.width = 5}
par(mfrow = c(3, 2))
for (cov in c('BCD4', 'BVL', 'WT', 'HT', 'FFM', 'BMI')) { 
  hist(data_unique[ ,cov],
       main = cov)
  
  }
```


**Questions:** what information does this plot reveal regarding:

1. The range of each covariate? 
BCD4 100-350
BVL 5000-20000
WT 40-140
HT 120-220
FFM 20-100
2. The shape of the distribution of each covariate? 
Except BMI which may look more like normal distribution, all of them appear to follow a log normal distribution. 


### Correlation Matrix


```{r pair plot, fig.height = 6}
pairs(data_unique[, c("BCD4", "BVL", "WT", "HT", "FFM", "BMI")],
      upper.panel = NULL,
      lower.panel = panel.smooth,
      pch = 20)
```

**Questions:**

1. Which covariates are highly correlated?
WT and HT, WT and FFM, HT and FFM
2. Which covariates are poorly correlated?
All the rest


## Discrete Covariates
### Box Plots


```{r boxplots}
par(mfrow = c(2, 2))
boxplot(WT~CBMI, data = data_unique, main = "WT vs CBMI") 
boxplot(FFM~SEX, data = data_unique, main = "FFM vs SEX")
boxplot(BCD4~TB, data = data_unique, main = "BCD4 vs TB")
boxplot(BVL~AECD4, data = data_unique, main = "BVL vs AECD4")
```


**Questions:**

1. Can you find correlations between any of the covariates?
Males have higher FFM, HIV+TB group has lower BCD4 levels, 
2. Provide a brief explanation on what could explain these correlations.
Males have higher FFM because they have less percentage of fat, and more weight related to muscle, HT, etc.
HIV + TB have less BCD4 because they also have turberculousis infection which decreases their defenses.
The higher AECD4 levels the higher BVL levels, which can explaint due to more adverse events of CD4 means there are higher levels of virus. 

---

**The End**
